# TÃ­nh nÄƒng Lá»c Dashboard theo NÆ¡i BÃ¡o CÃ¡o

## Tá»•ng quan

TÃ­nh nÄƒng nÃ y cho phÃ©p ngÆ°á»i dÃ¹ng xem dashboard vÃ  thá»‘ng kÃª Ä‘Æ°á»£c lá»c theo tá»«ng nÆ¡i bÃ¡o cÃ¡o (department/organization). NgÆ°á»i dÃ¹ng cÃ³ thá»ƒ chá»n xem táº¥t cáº£ dá»¯ liá»‡u hoáº·c chá»‰ xem dá»¯ liá»‡u cá»§a má»™t nÆ¡i bÃ¡o cÃ¡o cá»¥ thá»ƒ.

## TÃ­nh nÄƒng

### 1. Dropdown Filter
- Vá»‹ trÃ­: GÃ³c trÃªn bÃªn pháº£i cá»§a dashboard, bÃªn cáº¡nh tiÃªu Ä‘á»
- Icon: Biá»ƒu tÆ°á»£ng phá»…u (FunnelIcon) Ä‘á»ƒ dá»… nháº­n biáº¿t
- TÃ¹y chá»n:
  - "Táº¥t cáº£ nÆ¡i bÃ¡o cÃ¡o" (máº·c Ä‘á»‹nh) - Hiá»ƒn thá»‹ toÃ n bá»™ dá»¯ liá»‡u
  - CÃ¡c department cá»¥ thá»ƒ - Chá»‰ hiá»ƒn thá»‹ dá»¯ liá»‡u cá»§a department Ä‘Ã£ chá»n

### 2. Dá»¯ liá»‡u Ä‘Æ°á»£c lá»c

Khi chá»n má»™t nÆ¡i bÃ¡o cÃ¡o cá»¥ thá»ƒ, cÃ¡c thÃ nh pháº§n sau sáº½ Ä‘Æ°á»£c lá»c:

#### Thá»‘ng kÃª tá»•ng quan:
- Tá»•ng sá»‘ bÃ¡o cÃ¡o
- BÃ¡o cÃ¡o thÃ¡ng nÃ y
- BÃ¡o cÃ¡o nghiÃªm trá»ng
- TÄƒng trÆ°á»Ÿng so vá»›i thÃ¡ng trÆ°á»›c

#### Biá»ƒu Ä‘á»“:
1. **PhÃ¢n bá»‘ Ä‘á»™ tuá»•i** - Chá»‰ hiá»ƒn thá»‹ Ä‘á»™ tuá»•i bá»‡nh nhÃ¢n tá»« nÆ¡i bÃ¡o cÃ¡o Ä‘Ã£ chá»n
2. **Má»©c Ä‘á»™ nghiÃªm trá»ng** - PhÃ¢n tÃ­ch má»©c Ä‘á»™ nghiÃªm trá»ng theo nÆ¡i bÃ¡o cÃ¡o
3. **Xu hÆ°á»›ng theo thÃ¡ng** - Xu hÆ°á»›ng bÃ¡o cÃ¡o 12 thÃ¡ng gáº§n nháº¥t cá»§a nÆ¡i bÃ¡o cÃ¡o
4. **PhÃ¢n bá»‘ thuá»‘c** - Top 10 thuá»‘c nghi ngá» táº¡i nÆ¡i bÃ¡o cÃ¡o
5. **Káº¿t quáº£ Ä‘iá»u trá»‹** - Káº¿t quáº£ sau Ä‘iá»u trá»‹ táº¡i nÆ¡i bÃ¡o cÃ¡o
6. **Top cÆ¡ sá»Ÿ** - Danh sÃ¡ch cÆ¡ sá»Ÿ (khi chá»n táº¥t cáº£) hoáº·c chá»‰ nÆ¡i bÃ¡o cÃ¡o Ä‘Ã£ chá»n
7. **Top thuá»‘c nghi ngá»** - Top 10 thuá»‘c chi tiáº¿t táº¡i nÆ¡i bÃ¡o cÃ¡o
8. **PhÃ¢n tÃ­ch nghá» nghiá»‡p** - PhÃ¢n tÃ­ch ngÆ°á»i bÃ¡o cÃ¡o theo nghá» nghiá»‡p táº¡i nÆ¡i bÃ¡o cÃ¡o
9. **BÃ¡o cÃ¡o theo ngÃ y** - Xu hÆ°á»›ng bÃ¡o cÃ¡o theo ngÃ y cá»§a nÆ¡i bÃ¡o cÃ¡o
10. **PhÃ¢n bá»‘ giá»›i tÃ­nh** - PhÃ¢n bá»‘ giá»›i tÃ­nh bá»‡nh nhÃ¢n táº¡i nÆ¡i bÃ¡o cÃ¡o

### 3. Indicator

Khi má»™t nÆ¡i bÃ¡o cÃ¡o Ä‘Æ°á»£c chá»n (khÃ´ng pháº£i "Táº¥t cáº£"), má»™t badge sáº½ hiá»ƒn thá»‹:
- Vá»‹ trÃ­: BÃªn pháº£i tiÃªu Ä‘á» "Thá»‘ng kÃª vÃ  phÃ¢n tÃ­ch"
- Ná»™i dung: "Lá»c theo: [TÃªn nÆ¡i bÃ¡o cÃ¡o]"
- MÃ u sáº¯c: Ná»n xanh nháº¡t vá»›i chá»¯ xanh Ä‘áº­m

## CÃ¡ch sá»­ dá»¥ng

### BÆ°á»›c 1: Truy cáº­p Dashboard
```
ÄÄƒng nháº­p â†’ Dashboard
```

### BÆ°á»›c 2: Chá»n nÆ¡i bÃ¡o cÃ¡o
1. NhÃ¬n vÃ o gÃ³c trÃªn bÃªn pháº£i cá»§a trang
2. TÃ¬m dropdown cÃ³ icon phá»…u vÃ  text "Táº¥t cáº£ nÆ¡i bÃ¡o cÃ¡o"
3. Click vÃ o dropdown
4. Chá»n nÆ¡i bÃ¡o cÃ¡o muá»‘n xem

### BÆ°á»›c 3: Xem káº¿t quáº£
- Táº¥t cáº£ thá»‘ng kÃª vÃ  biá»ƒu Ä‘á»“ sáº½ tá»± Ä‘á»™ng cáº­p nháº­t
- Badge "Lá»c theo" sáº½ xuáº¥t hiá»‡n Ä‘á»ƒ xÃ¡c nháº­n filter Ä‘ang active

### BÆ°á»›c 4: Xem láº¡i táº¥t cáº£
- Chá»n "Táº¥t cáº£ nÆ¡i bÃ¡o cÃ¡o" tá»« dropdown Ä‘á»ƒ quay láº¡i xem toÃ n bá»™ dá»¯ liá»‡u

## Kiáº¿n trÃºc ká»¹ thuáº­t

### 1. Frontend

#### Dashboard Page (`app/dashboard/page.tsx`)
```typescript
// State management
const [departments, setDepartments] = useState<Department[]>([]);
const [selectedOrganization, setSelectedOrganization] = useState<string>('all');

// Load departments tá»« API
const loadDepartments = async () => {
  const response = await fetch('/api/public/departments');
  const result = await response.json();
  if (result.success) {
    setDepartments(result.data);
  }
};

// Load stats vá»›i organization filter
const loadStats = async () => {
  const url = selectedOrganization !== 'all'
    ? `/api/dashboard/stats?organization=${encodeURIComponent(selectedOrganization)}`
    : '/api/dashboard/stats';
  const response = await fetch(url);
  // ...
};
```

#### DashboardCharts Component
```typescript
interface DashboardChartsProps {
  organization?: string;  // New prop
}

// Pass organization filter to API
const url = organization && organization !== 'all' 
  ? `/api/dashboard/charts?organization=${encodeURIComponent(organization)}`
  : '/api/dashboard/charts';
```

### 2. Backend

#### Stats API (`app/api/dashboard/stats/route.ts`)
```typescript
export async function GET(request: NextRequest) {
  // Get organization filter from query params
  const { searchParams } = new URL(request.url);
  const organization = searchParams.get('organization');
  
  // Apply filter
  let reportsQuery = supabase.from('adr_reports').select('*');
  if (organization && organization !== 'all') {
    reportsQuery = reportsQuery.eq('organization', organization);
  }
  // ...
}
```

#### Charts API (`app/api/dashboard/charts/route.ts`)
```typescript
export async function GET(request: NextRequest) {
  const organization = searchParams.get('organization');
  
  // Helper function
  const addOrgFilter = (query: any) => {
    if (organization && organization !== 'all') {
      return query.eq('organization', organization);
    }
    return query;
  };
  
  // Apply to all queries
  let query = supabase.from('adr_reports').select('...');
  query = addOrgFilter(query);
  
  // For suspected_drugs (vá»›i join)
  let query = supabase
    .from('suspected_drugs')
    .select('drug_name, adr_reports!inner(organization)');
  if (organization && organization !== 'all') {
    query = query.eq('adr_reports.organization', organization);
  }
}
```

### 3. Data Flow

```
User selects organization
    â†“
Dashboard state updates
    â†“
Triggers re-fetch of stats and charts
    â†“
API receives organization parameter
    â†“
Supabase queries filtered by organization
    â†“
Data returned and displayed
```

## LÆ°u Ã½ ká»¹ thuáº­t

### 1. Performance
- Filter Ä‘Æ°á»£c thá»±c hiá»‡n á»Ÿ database level (Supabase)
- KhÃ´ng cáº§n load toÃ n bá»™ data rá»“i filter á»Ÿ client
- Queries Ä‘Æ°á»£c optimize vá»›i indexes trÃªn cá»™t `organization`

### 2. Data Consistency
- Sá»­ dá»¥ng báº£ng `departments` Ä‘á»ƒ láº¥y danh sÃ¡ch nÆ¡i bÃ¡o cÃ¡o há»£p lá»‡
- Filter theo trÆ°á»ng `organization` trong báº£ng `adr_reports`
- Äáº£m báº£o tÃªn organization pháº£i khá»›p chÃ­nh xÃ¡c (case-sensitive)

### 3. Join Queries
- Vá»›i `suspected_drugs` vÃ  `concurrent_drugs`, cáº§n join vá»›i `adr_reports` Ä‘á»ƒ filter
- Sá»­ dá»¥ng `!inner` join Ä‘á»ƒ chá»‰ láº¥y records cÃ³ report tÆ°Æ¡ng á»©ng
- Syntax: `.select('field, adr_reports!inner(organization)')`

### 4. Default Behavior
- Máº·c Ä‘á»‹nh hiá»ƒn thá»‹ "Táº¥t cáº£ nÆ¡i bÃ¡o cÃ¡o"
- Parameter `organization=all` hoáº·c khÃ´ng cÃ³ parameter = khÃ´ng filter

## Testing

### Test Case 1: View All
1. Má»Ÿ dashboard
2. Verify dropdown hiá»ƒn thá»‹ "Táº¥t cáº£ nÆ¡i bÃ¡o cÃ¡o"
3. Verify stats hiá»ƒn thá»‹ táº¥t cáº£ data
4. Verify khÃ´ng cÃ³ badge "Lá»c theo"

### Test Case 2: Filter by Organization
1. Chá»n má»™t department tá»« dropdown
2. Verify stats thay Ä‘á»•i
3. Verify badge "Lá»c theo" hiá»ƒn thá»‹
4. Verify táº¥t cáº£ charts cáº­p nháº­t
5. So sÃ¡nh sá»‘ liá»‡u vá»›i database

### Test Case 3: Switch Organizations
1. Chá»n department A
2. Note sá»‘ liá»‡u
3. Chá»n department B
4. Verify sá»‘ liá»‡u khÃ¡c nhau
5. Chá»n láº¡i "Táº¥t cáº£"
6. Verify quay vá» táº¥t cáº£ data

### Test Case 4: Empty Results
1. Chá»n department khÃ´ng cÃ³ bÃ¡o cÃ¡o nÃ o
2. Verify hiá»ƒn thá»‹ "0" trong stats
3. Verify charts hiá»ƒn thá»‹ empty state
4. KhÃ´ng cÃ³ error

## Troubleshooting

### Issue 1: Dropdown khÃ´ng hiá»ƒn thá»‹ departments
**NguyÃªn nhÃ¢n**: API `/api/public/departments` khÃ´ng hoáº¡t Ä‘á»™ng
**Giáº£i phÃ¡p**:
- Kiá»ƒm tra báº£ng `departments` cÃ³ dá»¯ liá»‡u
- Kiá»ƒm tra RLS policies cho báº£ng `departments`
- Check console logs

### Issue 2: Filter khÃ´ng hoáº¡t Ä‘á»™ng
**NguyÃªn nhÃ¢n**: Organization name khÃ´ng khá»›p
**Giáº£i phÃ¡p**:
- Kiá»ƒm tra tÃªn organization trong `adr_reports` khá»›p vá»›i `departments`
- Sá»­ dá»¥ng script fix-organizations náº¿u cáº§n
- Verify case-sensitivity

### Issue 3: Charts khÃ´ng cáº­p nháº­t
**NguyÃªn nhÃ¢n**: Component khÃ´ng re-render
**Giáº£i phÃ¡p**:
- Kiá»ƒm tra useEffect dependencies
- Verify organization prop Ä‘Æ°á»£c truyá»n Ä‘Ãºng
- Check network tab Ä‘á»ƒ xem API cÃ³ Ä‘Æ°á»£c gá»i vá»›i Ä‘Ãºng params

## Future Enhancements

### 1. Multi-select
Cho phÃ©p chá»n nhiá»u nÆ¡i bÃ¡o cÃ¡o cÃ¹ng lÃºc Ä‘á»ƒ so sÃ¡nh

### 2. Date Range Filter
Káº¿t há»£p filter organization vá»›i filter theo khoáº£ng thá»i gian

### 3. Save Preferences
LÆ°u lá»±a chá»n organization cá»§a user Ä‘á»ƒ láº§n sau tá»± Ä‘á»™ng load

### 4. Export
Xuáº¥t bÃ¡o cÃ¡o Ä‘Ã£ filter ra PDF/Excel

### 5. Comparison View
Hiá»ƒn thá»‹ 2-3 organizations cáº¡nh nhau Ä‘á»ƒ so sÃ¡nh

## API Documentation

### GET /api/dashboard/stats
**Query Parameters:**
- `organization` (optional): TÃªn organization Ä‘á»ƒ filter. Náº¿u khÃ´ng cÃ³ hoáº·c = 'all' thÃ¬ khÃ´ng filter

**Response:**
```json
{
  "totalReports": 100,
  "newReportsThisMonth": 20,
  "criticalReports": 5,
  "previousMonthReports": 15,
  "growthRate": 33.3,
  "totalUsers": 50
}
```

### GET /api/dashboard/charts
**Query Parameters:**
- `organization` (optional): TÃªn organization Ä‘á»ƒ filter
- `type` (optional): Loáº¡i chart cá»¥ thá»ƒ (age, severity, trends, etc.)

**Response:**
```json
{
  "success": true,
  "data": {
    "ageDistribution": [...],
    "severityDistribution": [...],
    "monthlyTrends": [...],
    "drugDistribution": [...],
    "outcomeDistribution": [...],
    "topFacilities": [...],
    "topDrugs": [...],
    "occupationAnalysis": [...],
    "reportsByDate": [...],
    "genderDistribution": [...]
  }
}
```

## Changelog

### Version 1.0.0 (2025-10-04)
- âœ¨ Initial release
- âœ¨ Add organization dropdown filter
- âœ¨ Filter stats by organization
- âœ¨ Filter all charts by organization
- âœ¨ Add filter indicator badge
- ğŸ”§ Optimize database queries with organization filter
- ğŸ“š Add comprehensive documentation

---

**Developed by**: AI Assistant
**Date**: October 4, 2025
**Version**: 1.0.0





